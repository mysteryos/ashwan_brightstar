/*! jquery.atwho - v1.4.0 %>
* Copyright (c) 2015 chord.luo <chord.luo@gmail.com>;
* homepage: http://ichord.github.com/At.js
* Licensed MIT
*/
(function(a,b){if(typeof define==="function"&&define.amd){define(["jquery"],function(c){return(b(c))})}else{if(typeof exports==="object"){module.exports=b(require("jquery"))}else{b(jQuery)}}}(this,function(c){var g,i,e,f,m,b,n,d,h,a,l=[].slice,k=function(r,p){for(var o in p){if(j.call(p,o)){r[o]=p[o]}}function q(){this.constructor=r}q.prototype=p.prototype;r.prototype=new q();r.__super__=p.prototype;return r},j={}.hasOwnProperty;g=c;e=(function(){function o(p){this.currentFlag=null;this.controllers={};this.aliasMaps={};this.$inputor=g(p);this.setupRootElement();this.listen()}o.prototype.createContainer=function(q){var p;if((p=this.$el)!=null){p.remove()}return g(q.body).append(this.$el=g("<div class='atwho-container'></div>"))};o.prototype.setupRootElement=function(q,s){var p;if(s==null){s=false}if(q){this.window=q.contentWindow;this.document=q.contentDocument||this.window.document;this.iframe=q}else{this.document=this.$inputor[0].ownerDocument;this.window=this.document.defaultView||this.document.parentWindow;try{this.iframe=this.window.frameElement}catch(r){p=r;this.iframe=null;if(g.fn.atwho.debug){throw new Error("iframe auto-discovery is failed.\nPlease use `setIframe` to set the target iframe manually.\n"+p)}}}return this.createContainer((this.iframeAsRoot=s)?this.document:document)};o.prototype.controller=function(p){var t,r,s,q;if(this.aliasMaps[p]){r=this.controllers[this.aliasMaps[p]]}else{q=this.controllers;for(s in q){t=q[s];if(s===p){r=t;break}}}if(r){return r}else{return this.controllers[this.currentFlag]}};o.prototype.setContextFor=function(p){this.currentFlag=p;return this};o.prototype.reg=function(q,r){var s,p;p=(s=this.controllers)[q]||(s[q]=this.$inputor.is("[contentEditable]")?new b(this,q):new h(this,q));if(r.alias){this.aliasMaps[r.alias]=q}p.init(r);return this};o.prototype.listen=function(){return this.$inputor.on("compositionstart",(function(p){return function(r){var q;if((q=p.controller())!=null){q.view.hide()}p.isComposing=true;return null}})(this)).on("compositionend",(function(p){return function(q){p.isComposing=false;return null}})(this)).on("keyup.atwhoInner",(function(p){return function(q){return p.onKeyup(q)}})(this)).on("keydown.atwhoInner",(function(p){return function(q){return p.onKeydown(q)}})(this)).on("blur.atwhoInner",(function(p){return function(q){var r;if(r=p.controller()){r.expectedQueryCBId=null;return r.view.hide(q,r.getOpt("displayTimeout"))}}})(this)).on("click.atwhoInner",(function(p){return function(q){return p.dispatch(q)}})(this)).on("scroll.atwhoInner",(function(p){return function(){var q;q=p.$inputor.scrollTop();return function(t){var s,r;s=t.target.scrollTop;if(q!==s){if((r=p.controller())!=null){r.view.hide(t)}}q=s;return true}}})(this)())};o.prototype.shutdown=function(){var p,r,q;q=this.controllers;for(p in q){r=q[p];r.destroy();delete this.controllers[p]}this.$inputor.off(".atwhoInner");return this.$el.remove()};o.prototype.dispatch=function(s){var p,t,r,q;r=this.controllers;q=[];for(p in r){t=r[p];q.push(t.lookUp(s))}return q};o.prototype.onKeyup=function(q){var p;switch(q.keyCode){case n.ESC:q.preventDefault();if((p=this.controller())!=null){p.view.hide()}break;case n.DOWN:case n.UP:case n.CTRL:case n.ENTER:g.noop();break;case n.P:case n.N:if(!q.ctrlKey){this.dispatch(q)}break;default:this.dispatch(q)}};o.prototype.onKeydown=function(r){var q,p;p=(q=this.controller())!=null?q.view:void 0;if(!(p&&p.visible())){return}switch(r.keyCode){case n.ESC:r.preventDefault();p.hide(r);break;case n.UP:r.preventDefault();p.prev();break;case n.DOWN:r.preventDefault();p.next();break;case n.P:if(!r.ctrlKey){return}r.preventDefault();p.prev();break;case n.N:if(!r.ctrlKey){return}r.preventDefault();p.next();break;case n.TAB:case n.ENTER:case n.SPACE:if(!p.visible()){return}if(!this.controller().getOpt("spaceSelectsMatch")&&r.keyCode===n.SPACE){return}if(!this.controller().getOpt("tabSelectsMatch")&&r.keyCode===n.TAB){return}if(p.highlighted()){r.preventDefault();p.choose(r)}else{p.hide(r)}break;default:g.noop()}};return o})();f=(function(){o.prototype.uid=function(){return(Math.random().toString(16)+"000000000").substr(2,8)+(new Date().getTime())};function o(q,p){this.app=q;this.at=p;this.$inputor=this.app.$inputor;this.id=this.$inputor[0].id||this.uid();this.expectedQueryCBId=null;this.setting=null;this.query=null;this.pos=0;this.range=null;if((this.$el=g("#atwho-ground-"+this.id,this.app.$el)).length===0){this.app.$el.append(this.$el=g("<div id='atwho-ground-"+this.id+"'></div>"))}this.model=new d(this);this.view=new a(this)}o.prototype.init=function(p){this.setting=g.extend({},this.setting||g.fn.atwho["default"],p);this.view.init();return this.model.reload(this.setting.data)};o.prototype.destroy=function(){this.trigger("beforeDestroy");this.model.destroy();this.view.destroy();return this.$el.remove()};o.prototype.callDefault=function(){var q,p,r;r=arguments[0],q=2<=arguments.length?l.call(arguments,1):[];try{return m[r].apply(this,q)}catch(s){p=s;return g.error(p+" Or maybe At.js doesn't have function "+r)}};o.prototype.trigger=function(q,s){var r,p;if(s==null){s=[]}s.push(this);r=this.getOpt("alias");p=r?q+"-"+r+".atwho":q+".atwho";return this.$inputor.trigger(p,s)};o.prototype.callbacks=function(p){return this.getOpt("callbacks")[p]||m[p]};o.prototype.getOpt=function(q,p){var r;try{return this.setting[q]}catch(s){r=s;return null}};o.prototype.insertContentFor=function(r){var q,p;p=this.getOpt("insertTpl");q=g.extend({},r.data("item-data"),{"atwho-at":this.at});return this.callbacks("tplEval").call(this,p,q,"onInsert")};o.prototype.renderView=function(p){var q;q=this.getOpt("searchKey");p=this.callbacks("sorter").call(this,this.query.text,p.slice(0,1001),q);return this.view.render(p.slice(0,this.getOpt("limit")))};o.arrayToDefaultHash=function(t){var r,s,p,q;if(!g.isArray(t)){return t}q=[];for(r=0,p=t.length;r<p;r++){s=t[r];if(g.isPlainObject(s)){q.push(s)}else{q.push({name:s})}}return q};o.prototype.lookUp=function(r){var p,q;if(r&&r.type==="click"&&!this.getOpt("lookUpOnClick")){return}if(this.getOpt("suspendOnComposing")&&this.app.isComposing){return}p=this.catchQuery(r);if(!p){this.expectedQueryCBId=null;return p}this.app.setContextFor(this.at);if(q=this.getOpt("delay")){this._delayLookUp(p,q)}else{this._lookUp(p)}return p};o.prototype._delayLookUp=function(r,s){var p,q;p=Date.now?Date.now():new Date().getTime();this.previousCallTime||(this.previousCallTime=p);q=s-(p-this.previousCallTime);if((0<q&&q<s)){this.previousCallTime=p;this._stopDelayedCall();return this.delayedCallTimeout=setTimeout((function(t){return function(){t.previousCallTime=0;t.delayedCallTimeout=null;return t._lookUp(r)}})(this),s)}else{this._stopDelayedCall();if(this.previousCallTime!==p){this.previousCallTime=0}return this._lookUp(r)}};o.prototype._stopDelayedCall=function(){if(this.delayedCallTimeout){clearTimeout(this.delayedCallTimeout);return this.delayedCallTimeout=null}};o.prototype._generateQueryCBId=function(){return{}};o.prototype._lookUp=function(q){var p;p=function(s,r){if(s!==this.expectedQueryCBId){return}if(r&&r.length>0){return this.renderView(this.constructor.arrayToDefaultHash(r))}else{return this.view.hide()}};this.expectedQueryCBId=this._generateQueryCBId();return this.model.query(q.text,g.proxy(p,this,this.expectedQueryCBId))};return o})();h=(function(o){k(p,o);function p(){return p.__super__.constructor.apply(this,arguments)}p.prototype.catchQuery=function(){var s,u,r,q,v,w,t;u=this.$inputor.val();s=this.$inputor.caret("pos",{iframe:this.app.iframe});t=u.slice(0,s);v=this.callbacks("matcher").call(this,this.at,t,this.getOpt("startWithSpace"));q=typeof v==="string";if(q&&v.length<this.getOpt("minLen",0)){return}if(q&&v.length<=this.getOpt("maxLen",20)){w=s-v.length;r=w+v.length;this.pos=w;v={text:v,headPos:w,endPos:r};this.trigger("matched",[this.at,v.text])}else{v=null;this.view.hide()}return this.query=v};p.prototype.rect=function(){var s,r,q;if(!(s=this.$inputor.caret("offset",this.pos-1,{iframe:this.app.iframe}))){return}if(this.app.iframe&&!this.app.iframeAsRoot){r=g(this.app.iframe).offset();s.left+=r.left;s.top+=r.top}q=this.app.document.selection?0:2;return{left:s.left,top:s.top,bottom:s.top+s.height+q}};p.prototype.insert=function(r,w){var u,s,q,t,v;u=this.$inputor;s=u.val();q=s.slice(0,Math.max(this.query.headPos-this.at.length,0));t=(t=this.getOpt("suffix"))===""?t:t||" ";r+=t;v=""+q+r+(s.slice(this.query.endPos||0));u.val(v);u.caret("pos",q.length+r.length,{iframe:this.app.iframe});if(!u.is(":focus")){u.focus()}return u.change()};return p})(f);b=(function(p){k(o,p);function o(){return o.__super__.constructor.apply(this,arguments)}o.prototype._getRange=function(){var q;q=this.app.window.getSelection();if(q.rangeCount>0){return q.getRangeAt(0)}};o.prototype._setRange=function(q,s,r){if(r==null){r=this._getRange()}if(!r){return}s=g(s)[0];if(q==="after"){r.setEndAfter(s);r.setStartAfter(s)}else{r.setEndBefore(s);r.setStartBefore(s)}r.collapse(false);return this._clearRange(r)};o.prototype._clearRange=function(q){var r;if(q==null){q=this._getRange()}r=this.app.window.getSelection();if(this.ctrl_a_pressed==null){r.removeAllRanges();return r.addRange(q)}};o.prototype._movingEvent=function(r){var q;return r.type==="click"||((q=r.which)===n.RIGHT||q===n.LEFT||q===n.UP||q===n.DOWN)};o.prototype._unwrap=function(r){var q;r=g(r).unwrap().get(0);if((q=r.nextSibling)&&q.nodeValue){r.nodeValue+=q.nodeValue;g(q).remove()}return r};o.prototype.catchQuery=function(x){var B,z,y,w,u,s,q,r,t,A,C,v;if(!(v=this._getRange())){return}if(!v.collapsed){return}if(x.which===n.ENTER){(z=g(v.startContainer).closest(".atwho-query")).contents().unwrap();if(z.is(":empty")){z.remove()}(z=g(".atwho-query",this.app.document)).text(z.text()).contents().last().unwrap();this._clearRange();return}if(/firefox/i.test(navigator.userAgent)){if(g(v.startContainer).is(this.$inputor)){this._clearRange();return}if(x.which===n.BACKSPACE&&v.startContainer.nodeType===document.ELEMENT_NODE&&(t=v.startOffset-1)>=0){y=v.cloneRange();y.setStart(v.startContainer,t);if(g(y.cloneContents()).contents().last().is(".atwho-inserted")){u=g(v.startContainer).contents().get(t);this._setRange("after",g(u).contents().last())}}else{if(x.which===n.LEFT&&v.startContainer.nodeType===document.TEXT_NODE){B=g(v.startContainer.previousSibling);if(B.is(".atwho-inserted")&&v.startOffset===0){this._setRange("after",B.contents().last())}}}}g(v.startContainer).closest(".atwho-inserted").addClass("atwho-query").siblings().removeClass("atwho-query");if((z=g(".atwho-query",this.app.document)).length>0&&z.is(":empty")&&z.text().length===0){z.remove()}if(!this._movingEvent(x)){z.removeClass("atwho-inserted")}if(z.length>0){switch(x.which){case n.LEFT:this._setRange("before",z.get(0),v);z.removeClass("atwho-query");return;case n.RIGHT:this._setRange("after",z.get(0).nextSibling,v);z.removeClass("atwho-query");return}}if(z.length>0&&(C=z.attr("data-atwho-at-query"))){z.empty().html(C).attr("data-atwho-at-query",null);this._setRange("after",z.get(0),v)}y=v.cloneRange();y.setStart(v.startContainer,0);r=this.callbacks("matcher").call(this,this.at,y.toString(),this.getOpt("startWithSpace"));s=typeof r==="string";if(z.length===0&&s&&(w=v.startOffset-this.at.length-r.length)>=0){v.setStart(v.startContainer,w);z=g("<span/>",this.app.document).attr(this.getOpt("editableAtwhoQueryAttrs")).addClass("atwho-query");v.surroundContents(z.get(0));q=z.contents().last().get(0);if(/firefox/i.test(navigator.userAgent)){v.setStart(q,q.length);v.setEnd(q,q.length);this._clearRange(v)}else{this._setRange("after",q,v)}}if(s&&r.length<this.getOpt("minLen",0)){return}if(s&&r.length<=this.getOpt("maxLen",20)){A={text:r,el:z};this.trigger("matched",[this.at,A.text]);return this.query=A}else{this.view.hide();this.query={el:z};if(z.text().indexOf(this.at)>=0){if(this._movingEvent(x)&&z.hasClass("atwho-inserted")){z.removeClass("atwho-query")}else{if(false!==this.callbacks("afterMatchFailed").call(this,this.at,z)){this._setRange("after",this._unwrap(z.text(z.text()).contents().first()))}}}return null}};o.prototype.rect=function(){var s,r,q;q=this.query.el.offset();if(this.app.iframe&&!this.app.iframeAsRoot){r=(s=g(this.app.iframe)).offset();q.left+=r.left-this.$inputor.scrollLeft();q.top+=r.top-this.$inputor.scrollTop()}q.bottom=q.top+this.query.el.height();return q};o.prototype.insert=function(s,v){var t,q,u,r;u=(u=this.getOpt("suffix"))===""?u:u||"\u00A0";t=v.data("item-data");this.query.el.removeClass("atwho-query").addClass("atwho-inserted").html(s).attr("data-atwho-at-query",""+t["atwho-at"]+this.query.text);if(q=this._getRange()){q.setEndAfter(this.query.el[0]);q.collapse(false);q.insertNode(r=this.app.document.createTextNode("\u200D"+u));this._setRange("after",r,q)}if(!this.$inputor.is(":focus")){this.$inputor.focus()}return this.$inputor.change()};return o})(f);d=(function(){function o(p){this.context=p;this.at=this.context.at;this.storage=this.context.$inputor}o.prototype.destroy=function(){return this.storage.data(this.at,null)};o.prototype.saved=function(){return this.fetch()>0};o.prototype.query=function(q,t){var s,p,r;p=this.fetch();r=this.context.getOpt("searchKey");p=this.context.callbacks("filter").call(this.context,q,p,r)||[];s=this.context.callbacks("remoteFilter");if(p.length>0||(!s&&p.length===0)){return t(p)}else{return s.call(this.context,q,t)}};o.prototype.fetch=function(){return this.storage.data(this.at)||[]};o.prototype.save=function(p){return this.storage.data(this.at,this.context.callbacks("beforeSave").call(this.context,p||[]))};o.prototype.load=function(p){if(!(this.saved()||!p)){return this._load(p)}};o.prototype.reload=function(p){return this._load(p)};o.prototype._load=function(p){if(typeof p==="string"){return g.ajax(p,{dataType:"json"}).done((function(q){return function(r){return q.save(r)}})(this))}else{return this.save(p)}};return o})();a=(function(){function o(p){this.context=p;this.$el=g("<div class='atwho-view'><ul class='atwho-view-ul'></ul></div>");this.timeoutID=null;this.context.$el.append(this.$el);this.bindEvent()}o.prototype.init=function(){var p;p=this.context.getOpt("alias")||this.context.at.charCodeAt(0);return this.$el.attr({id:"at-view-"+p})};o.prototype.destroy=function(){return this.$el.remove()};o.prototype.bindEvent=function(){var p;p=this.$el.find("ul");return p.on("mouseenter.atwho-view","li",function(q){p.find(".cur").removeClass("cur");return g(q.currentTarget).addClass("cur")}).on("click.atwho-view","li",(function(q){return function(r){p.find(".cur").removeClass("cur");g(r.currentTarget).addClass("cur");q.choose(r);return r.preventDefault()}})(this))};o.prototype.visible=function(){return this.$el.is(":visible")};o.prototype.highlighted=function(){return this.$el.find(".cur").length>0};o.prototype.choose=function(q){var r,p;if((r=this.$el.find(".cur")).length){p=this.context.insertContentFor(r);this.context._stopDelayedCall();this.context.insert(this.context.callbacks("beforeInsert").call(this.context,p,r),r);this.context.trigger("inserted",[r,q]);this.hide(q)}if(this.context.getOpt("hideWithoutSuffix")){return this.stopShowing=true}};o.prototype.reposition=function(r){var t,s,p,q;t=this.context.app.iframeAsRoot?this.context.app.window:window;if(r.bottom+this.$el.height()-g(t).scrollTop()>g(t).height()){r.bottom=r.top-this.$el.height()}if(r.left>(p=g(t).width()-this.$el.width()-5)){r.left=p}s={left:r.left,top:r.bottom};if((q=this.context.callbacks("beforeReposition"))!=null){q.call(this.context,s)}this.$el.offset(s);return this.context.trigger("reposition",[s])};o.prototype.next=function(){var q,p;q=this.$el.find(".cur").removeClass("cur");p=q.next();if(!p.length){p=this.$el.find("li:first")}p.addClass("cur");return this.scrollTop(Math.max(0,q.innerHeight()*(p.index()+2)-this.$el.height()))};o.prototype.prev=function(){var q,p;q=this.$el.find(".cur").removeClass("cur");p=q.prev();if(!p.length){p=this.$el.find("li:last")}p.addClass("cur");return this.scrollTop(Math.max(0,q.innerHeight()*(p.index()+2)-this.$el.height()))};o.prototype.scrollTop=function(p){var q;q=this.context.getOpt("scrollDuration");if(q){return this.$el.animate({scrollTop:p},q)}else{return this.$el.scrollTop(p)}};o.prototype.show=function(){var p;if(this.stopShowing){this.stopShowing=false;return}if(!this.visible()){this.$el.show();this.$el.scrollTop(0);this.context.trigger("shown")}if(p=this.context.rect()){return this.reposition(p)}};o.prototype.hide=function(q,p){var r;if(!this.visible()){return}if(isNaN(p)){this.$el.hide();return this.context.trigger("hidden",[q])}else{r=(function(s){return function(){return s.hide()}})(this);clearTimeout(this.timeoutID);return this.timeoutID=setTimeout(r,p)}};o.prototype.render=function(v){var w,s,t,u,q,p,r;if(!(g.isArray(v)&&v.length>0)){this.hide();return}this.$el.find("ul").empty();s=this.$el.find("ul");r=this.context.getOpt("displayTpl");for(t=0,q=v.length;t<q;t++){u=v[t];u=g.extend({},u,{"atwho-at":this.context.at});p=this.context.callbacks("tplEval").call(this.context,r,u,"onDisplay");w=g(this.context.callbacks("highlighter").call(this.context,p,this.context.query.text));w.data("item-data",u);s.append(w)}this.show();if(this.context.getOpt("highlightFirst")){return s.find("li:first").addClass("cur")}};return o})();n={DOWN:40,UP:38,ESC:27,TAB:9,ENTER:13,CTRL:17,A:65,P:80,N:78,LEFT:37,UP:38,RIGHT:39,DOWN:40,BACKSPACE:8,SPACE:32};m={beforeSave:function(o){return f.arrayToDefaultHash(o)},matcher:function(t,w,q,r){var v,u,p,s,o;t=t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");if(q){t="(?:^|\\s)"+t}v=decodeURI("%C3%80");u=decodeURI("%C3%BF");o=r?" ":"";s=new RegExp(t+"([A-Za-z"+v+"-"+u+"0-9_"+o+"'.+-]*)$|"+t+"([^\\x00-\\xff]*)$","gi");p=s.exec(w);if(p){return p[2]||p[1]}else{return null}},filter:function(t,s,u){var p,q,r,o;p=[];for(q=0,o=s.length;q<o;q++){r=s[q];if(~new String(r[u]).toLowerCase().indexOf(t.toLowerCase())){p.push(r)}}return p},remoteFilter:null,sorter:function(t,q,u){var p,r,s,o;if(!t){return q}p=[];for(r=0,o=q.length;r<o;r++){s=q[r];s.atwho_order=new String(s[u]).toLowerCase().indexOf(t.toLowerCase());if(s.atwho_order>-1){p.push(s)}}return p.sort(function(w,v){return w.atwho_order-v.atwho_order})},tplEval:function(p,r){var o,q;q=p;try{if(typeof p!=="string"){q=p(r)}return q.replace(/\$\{([^\}]*)\}/g,function(t,u,v){return r[u]})}catch(s){o=s;return""}},highlighter:function(o,q){var p;if(!q){return o}p=new RegExp(">\\s*(\\w*?)("+q.replace("+","\\+")+")(\\w*)\\s*<","ig");return o.replace(p,function(t,r,u,s){return"> "+r+"<strong>"+u+"</strong>"+s+" <"})},beforeInsert:function(o,p){return o},beforeReposition:function(o){return o},afterMatchFailed:function(o,p){}};i={load:function(o,p){var q;if(q=this.controller(o)){return q.model.load(p)}},isSelecting:function(){var o;return !!((o=this.controller())!=null?o.view.visible():void 0)},hide:function(){var o;return(o=this.controller())!=null?o.view.hide():void 0},reposition:function(){var o;if(o=this.controller()){return o.view.reposition(o.rect())}},setIframe:function(o,p){this.setupRootElement(o,p);return null},run:function(){return this.dispatch()},destroy:function(){this.shutdown();return this.$inputor.data("atwho",null)}};g.fn.atwho=function(q){var p,o;p=arguments;o=null;this.filter('textarea, input, [contenteditable=""], [contenteditable=true]').each(function(){var r,s;if(!(s=(r=g(this)).data("atwho"))){r.data("atwho",(s=new e(this)))}if(typeof q==="object"||!q){return s.reg(q.at,q)}else{if(i[q]&&s){return o=i[q].apply(s,Array.prototype.slice.call(p,1))}else{return g.error("Method "+q+" does not exist on jQuery.atwho")}}});if(o!=null){return o}else{return this}};g.fn.atwho["default"]={at:void 0,alias:void 0,data:null,displayTpl:"<li>${name}</li>",insertTpl:"${atwho-at}${name}",callbacks:m,searchKey:"name",suffix:void 0,hideWithoutSuffix:false,startWithSpace:true,highlightFirst:true,limit:5,maxLen:20,minLen:0,displayTimeout:300,delay:null,spaceSelectsMatch:false,tabSelectsMatch:true,editableAtwhoQueryAttrs:{},scrollDuration:150,suspendOnComposing:true,lookUpOnClick:true};g.fn.atwho.debug=false}));