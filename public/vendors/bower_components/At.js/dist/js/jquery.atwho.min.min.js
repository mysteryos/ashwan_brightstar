/*! jquery.atwho - v1.4.0 %>
* Copyright (c) 2015 chord.luo <chord.luo@gmail.com>;
* homepage: http://ichord.github.com/At.js
* Licensed MIT
*/
(function(d,c){if(typeof define==="function"&&define.amd){define(["jquery"],function(a){return(c(a))})}else{if(typeof exports==="object"){module.exports=c(require("jquery"))}else{c(jQuery)}}}(this,function(z){var v,t,x,w,p,A,o,y,u,B,q=[].slice,r=function(a,c){for(var d in c){if(s.call(c,d)){a[d]=c[d]}}function b(){this.constructor=a}b.prototype=c.prototype;a.prototype=new b();a.__super__=c.prototype;return a},s={}.hasOwnProperty;v=z;x=(function(){function a(b){this.currentFlag=null;this.controllers={};this.aliasMaps={};this.$inputor=v(b);this.setupRootElement();this.listen()}a.prototype.createContainer=function(b){var c;if((c=this.$el)!=null){c.remove()}return v(b.body).append(this.$el=v("<div class='atwho-container'></div>"))};a.prototype.setupRootElement=function(d,b){var e;if(b==null){b=false}if(d){this.window=d.contentWindow;this.document=d.contentDocument||this.window.document;this.iframe=d}else{this.document=this.$inputor[0].ownerDocument;this.window=this.document.defaultView||this.document.parentWindow;try{this.iframe=this.window.frameElement}catch(c){e=c;this.iframe=null;if(v.fn.atwho.debug){throw new Error("iframe auto-discovery is failed.\nPlease use `setIframe` to set the target iframe manually.\n"+e)}}}return this.createContainer((this.iframeAsRoot=b)?this.document:document)};a.prototype.controller=function(f){var b,d,c,e;if(this.aliasMaps[f]){d=this.controllers[this.aliasMaps[f]]}else{e=this.controllers;for(c in e){b=e[c];if(c===f){d=b;break}}}if(d){return d}else{return this.controllers[this.currentFlag]}};a.prototype.setContextFor=function(b){this.currentFlag=b;return this};a.prototype.reg=function(d,c){var b,e;e=(b=this.controllers)[d]||(b[d]=this.$inputor.is("[contentEditable]")?new A(this,d):new u(this,d));if(c.alias){this.aliasMaps[c.alias]=d}e.init(c);return this};a.prototype.listen=function(){return this.$inputor.on("compositionstart",(function(b){return function(c){var d;if((d=b.controller())!=null){d.view.hide()}b.isComposing=true;return null}})(this)).on("compositionend",(function(b){return function(c){b.isComposing=false;return null}})(this)).on("keyup.atwhoInner",(function(b){return function(c){return b.onKeyup(c)}})(this)).on("keydown.atwhoInner",(function(b){return function(c){return b.onKeydown(c)}})(this)).on("blur.atwhoInner",(function(b){return function(d){var c;if(c=b.controller()){c.expectedQueryCBId=null;return c.view.hide(d,c.getOpt("displayTimeout"))}}})(this)).on("click.atwhoInner",(function(b){return function(c){return b.dispatch(c)}})(this)).on("scroll.atwhoInner",(function(b){return function(){var c;c=b.$inputor.scrollTop();return function(d){var e,f;e=d.target.scrollTop;if(c!==e){if((f=b.controller())!=null){f.view.hide(d)}}c=e;return true}}})(this)())};a.prototype.shutdown=function(){var d,b,c;c=this.controllers;for(d in c){b=c[d];b.destroy();delete this.controllers[d]}this.$inputor.off(".atwhoInner");return this.$el.remove()};a.prototype.dispatch=function(c){var f,b,d,e;d=this.controllers;e=[];for(f in d){b=d[f];e.push(b.lookUp(c))}return e};a.prototype.onKeyup=function(b){var c;switch(b.keyCode){case o.ESC:b.preventDefault();if((c=this.controller())!=null){c.view.hide()}break;case o.DOWN:case o.UP:case o.CTRL:case o.ENTER:v.noop();break;case o.P:case o.N:if(!b.ctrlKey){this.dispatch(b)}break;default:this.dispatch(b)}};a.prototype.onKeydown=function(b){var c,d;d=(c=this.controller())!=null?c.view:void 0;if(!(d&&d.visible())){return}switch(b.keyCode){case o.ESC:b.preventDefault();d.hide(b);break;case o.UP:b.preventDefault();d.prev();break;case o.DOWN:b.preventDefault();d.next();break;case o.P:if(!b.ctrlKey){return}b.preventDefault();d.prev();break;case o.N:if(!b.ctrlKey){return}b.preventDefault();d.next();break;case o.TAB:case o.ENTER:case o.SPACE:if(!d.visible()){return}if(!this.controller().getOpt("spaceSelectsMatch")&&b.keyCode===o.SPACE){return}if(!this.controller().getOpt("tabSelectsMatch")&&b.keyCode===o.TAB){return}if(d.highlighted()){b.preventDefault();d.choose(b)}else{d.hide(b)}break;default:v.noop()}};return a})();w=(function(){a.prototype.uid=function(){return(Math.random().toString(16)+"000000000").substr(2,8)+(new Date().getTime())};function a(b,c){this.app=b;this.at=c;this.$inputor=this.app.$inputor;this.id=this.$inputor[0].id||this.uid();this.expectedQueryCBId=null;this.setting=null;this.query=null;this.pos=0;this.range=null;if((this.$el=v("#atwho-ground-"+this.id,this.app.$el)).length===0){this.app.$el.append(this.$el=v("<div id='atwho-ground-"+this.id+"'></div>"))}this.model=new y(this);this.view=new B(this)}a.prototype.init=function(b){this.setting=v.extend({},this.setting||v.fn.atwho["default"],b);this.view.init();return this.model.reload(this.setting.data)};a.prototype.destroy=function(){this.trigger("beforeDestroy");this.model.destroy();this.view.destroy();return this.$el.remove()};a.prototype.callDefault=function(){var d,e,c;c=arguments[0],d=2<=arguments.length?q.call(arguments,1):[];try{return p[c].apply(this,d)}catch(b){e=b;return v.error(e+" Or maybe At.js doesn't have function "+c)}};a.prototype.trigger=function(d,b){var c,e;if(b==null){b=[]}b.push(this);c=this.getOpt("alias");e=c?d+"-"+c+".atwho":d+".atwho";return this.$inputor.trigger(e,b)};a.prototype.callbacks=function(b){return this.getOpt("callbacks")[b]||p[b]};a.prototype.getOpt=function(d,e){var c;try{return this.setting[d]}catch(b){c=b;return null}};a.prototype.insertContentFor=function(b){var c,d;d=this.getOpt("insertTpl");c=v.extend({},b.data("item-data"),{"atwho-at":this.at});return this.callbacks("tplEval").call(this,d,c,"onInsert")};a.prototype.renderView=function(c){var b;b=this.getOpt("searchKey");c=this.callbacks("sorter").call(this,this.query.text,c.slice(0,1001),b);return this.view.render(c.slice(0,this.getOpt("limit")))};a.arrayToDefaultHash=function(b){var d,c,f,e;if(!v.isArray(b)){return b}e=[];for(d=0,f=b.length;d<f;d++){c=b[d];if(v.isPlainObject(c)){e.push(c)}else{e.push({name:c})}}return e};a.prototype.lookUp=function(b){var d,c;if(b&&b.type==="click"&&!this.getOpt("lookUpOnClick")){return}if(this.getOpt("suspendOnComposing")&&this.app.isComposing){return}d=this.catchQuery(b);if(!d){this.expectedQueryCBId=null;return d}this.app.setContextFor(this.at);if(c=this.getOpt("delay")){this._delayLookUp(d,c)}else{this._lookUp(d)}return d};a.prototype._delayLookUp=function(c,b){var e,d;e=Date.now?Date.now():new Date().getTime();this.previousCallTime||(this.previousCallTime=e);d=b-(e-this.previousCallTime);if((0<d&&d<b)){this.previousCallTime=e;this._stopDelayedCall();return this.delayedCallTimeout=setTimeout((function(f){return function(){f.previousCallTime=0;f.delayedCallTimeout=null;return f._lookUp(c)}})(this),b)}else{this._stopDelayedCall();if(this.previousCallTime!==e){this.previousCallTime=0}return this._lookUp(c)}};a.prototype._stopDelayedCall=function(){if(this.delayedCallTimeout){clearTimeout(this.delayedCallTimeout);return this.delayedCallTimeout=null}};a.prototype._generateQueryCBId=function(){return{}};a.prototype._lookUp=function(b){var c;c=function(d,e){if(d!==this.expectedQueryCBId){return}if(e&&e.length>0){return this.renderView(this.constructor.arrayToDefaultHash(e))}else{return this.view.hide()}};this.expectedQueryCBId=this._generateQueryCBId();return this.model.query(b.text,v.proxy(c,this,this.expectedQueryCBId))};return a})();u=(function(b){r(a,b);function a(){return a.__super__.constructor.apply(this,arguments)}a.prototype.catchQuery=function(){var g,e,h,i,d,c,f;e=this.$inputor.val();g=this.$inputor.caret("pos",{iframe:this.app.iframe});f=e.slice(0,g);d=this.callbacks("matcher").call(this,this.at,f,this.getOpt("startWithSpace"));i=typeof d==="string";if(i&&d.length<this.getOpt("minLen",0)){return}if(i&&d.length<=this.getOpt("maxLen",20)){c=g-d.length;h=c+d.length;this.pos=c;d={text:d,headPos:c,endPos:h};this.trigger("matched",[this.at,d.text])}else{d=null;this.view.hide()}return this.query=d};a.prototype.rect=function(){var c,d,e;if(!(c=this.$inputor.caret("offset",this.pos-1,{iframe:this.app.iframe}))){return}if(this.app.iframe&&!this.app.iframeAsRoot){d=v(this.app.iframe).offset();c.left+=d.left;c.top+=d.top}e=this.app.document.selection?0:2;return{left:c.left,top:c.top,bottom:c.top+c.height+e}};a.prototype.insert=function(h,c){var e,g,i,f,d;e=this.$inputor;g=e.val();i=g.slice(0,Math.max(this.query.headPos-this.at.length,0));f=(f=this.getOpt("suffix"))===""?f:f||" ";h+=f;d=""+i+h+(g.slice(this.query.endPos||0));e.val(d);e.caret("pos",i.length+h.length,{iframe:this.app.iframe});if(!e.is(":focus")){e.focus()}return e.change()};return a})(w);A=(function(a){r(b,a);function b(){return b.__super__.constructor.apply(this,arguments)}b.prototype._getRange=function(){var c;c=this.app.window.getSelection();if(c.rangeCount>0){return c.getRangeAt(0)}};b.prototype._setRange=function(e,c,d){if(d==null){d=this._getRange()}if(!d){return}c=v(c)[0];if(e==="after"){d.setEndAfter(c);d.setStartAfter(c)}else{d.setEndBefore(c);d.setStartBefore(c)}d.collapse(false);return this._clearRange(d)};b.prototype._clearRange=function(d){var c;if(d==null){d=this._getRange()}c=this.app.window.getSelection();if(this.ctrl_a_pressed==null){c.removeAllRanges();return c.addRange(d)}};b.prototype._movingEvent=function(c){var d;return c.type==="click"||((d=c.which)===o.RIGHT||d===o.LEFT||d===o.UP||d===o.DOWN)};b.prototype._unwrap=function(c){var d;c=v(c).unwrap().get(0);if((d=c.nextSibling)&&d.nodeValue){c.nodeValue+=d.nodeValue;v(d).remove()}return c};b.prototype.catchQuery=function(j){var f,h,i,k,m,D,e,c,n,g,d,l;if(!(l=this._getRange())){return}if(!l.collapsed){return}if(j.which===o.ENTER){(h=v(l.startContainer).closest(".atwho-query")).contents().unwrap();if(h.is(":empty")){h.remove()}(h=v(".atwho-query",this.app.document)).text(h.text()).contents().last().unwrap();this._clearRange();return}if(/firefox/i.test(navigator.userAgent)){if(v(l.startContainer).is(this.$inputor)){this._clearRange();return}if(j.which===o.BACKSPACE&&l.startContainer.nodeType===document.ELEMENT_NODE&&(n=l.startOffset-1)>=0){i=l.cloneRange();i.setStart(l.startContainer,n);if(v(i.cloneContents()).contents().last().is(".atwho-inserted")){m=v(l.startContainer).contents().get(n);this._setRange("after",v(m).contents().last())}}else{if(j.which===o.LEFT&&l.startContainer.nodeType===document.TEXT_NODE){f=v(l.startContainer.previousSibling);if(f.is(".atwho-inserted")&&l.startOffset===0){this._setRange("after",f.contents().last())}}}}v(l.startContainer).closest(".atwho-inserted").addClass("atwho-query").siblings().removeClass("atwho-query");if((h=v(".atwho-query",this.app.document)).length>0&&h.is(":empty")&&h.text().length===0){h.remove()}if(!this._movingEvent(j)){h.removeClass("atwho-inserted")}if(h.length>0){switch(j.which){case o.LEFT:this._setRange("before",h.get(0),l);h.removeClass("atwho-query");return;case o.RIGHT:this._setRange("after",h.get(0).nextSibling,l);h.removeClass("atwho-query");return}}if(h.length>0&&(d=h.attr("data-atwho-at-query"))){h.empty().html(d).attr("data-atwho-at-query",null);this._setRange("after",h.get(0),l)}i=l.cloneRange();i.setStart(l.startContainer,0);c=this.callbacks("matcher").call(this,this.at,i.toString(),this.getOpt("startWithSpace"));D=typeof c==="string";if(h.length===0&&D&&(k=l.startOffset-this.at.length-c.length)>=0){l.setStart(l.startContainer,k);h=v("<span/>",this.app.document).attr(this.getOpt("editableAtwhoQueryAttrs")).addClass("atwho-query");l.surroundContents(h.get(0));e=h.contents().last().get(0);if(/firefox/i.test(navigator.userAgent)){l.setStart(e,e.length);l.setEnd(e,e.length);this._clearRange(l)}else{this._setRange("after",e,l)}}if(D&&c.length<this.getOpt("minLen",0)){return}if(D&&c.length<=this.getOpt("maxLen",20)){g={text:c,el:h};this.trigger("matched",[this.at,g.text]);return this.query=g}else{this.view.hide();this.query={el:h};if(h.text().indexOf(this.at)>=0){if(this._movingEvent(j)&&h.hasClass("atwho-inserted")){h.removeClass("atwho-query")}else{if(false!==this.callbacks("afterMatchFailed").call(this,this.at,h)){this._setRange("after",this._unwrap(h.text(h.text()).contents().first()))}}}return null}};b.prototype.rect=function(){var c,d,e;e=this.query.el.offset();if(this.app.iframe&&!this.app.iframeAsRoot){d=(c=v(this.app.iframe)).offset();e.left+=d.left-this.$inputor.scrollLeft();e.top+=d.top-this.$inputor.scrollTop()}e.bottom=e.top+this.query.el.height();return e};b.prototype.insert=function(f,c){var e,h,d,g;d=(d=this.getOpt("suffix"))===""?d:d||"\u00A0";e=c.data("item-data");this.query.el.removeClass("atwho-query").addClass("atwho-inserted").html(f).attr("data-atwho-at-query",""+e["atwho-at"]+this.query.text);if(h=this._getRange()){h.setEndAfter(this.query.el[0]);h.collapse(false);h.insertNode(g=this.app.document.createTextNode("\u200D"+d));this._setRange("after",g,h)}if(!this.$inputor.is(":focus")){this.$inputor.focus()}return this.$inputor.change()};return b})(w);y=(function(){function a(b){this.context=b;this.at=this.context.at;this.storage=this.context.$inputor}a.prototype.destroy=function(){return this.storage.data(this.at,null)};a.prototype.saved=function(){return this.fetch()>0};a.prototype.query=function(e,b){var c,f,d;f=this.fetch();d=this.context.getOpt("searchKey");f=this.context.callbacks("filter").call(this.context,e,f,d)||[];c=this.context.callbacks("remoteFilter");if(f.length>0||(!c&&f.length===0)){return b(f)}else{return c.call(this.context,e,b)}};a.prototype.fetch=function(){return this.storage.data(this.at)||[]};a.prototype.save=function(b){return this.storage.data(this.at,this.context.callbacks("beforeSave").call(this.context,b||[]))};a.prototype.load=function(b){if(!(this.saved()||!b)){return this._load(b)}};a.prototype.reload=function(b){return this._load(b)};a.prototype._load=function(b){if(typeof b==="string"){return v.ajax(b,{dataType:"json"}).done((function(c){return function(d){return c.save(d)}})(this))}else{return this.save(b)}};return a})();B=(function(){function a(b){this.context=b;this.$el=v("<div class='atwho-view'><ul class='atwho-view-ul'></ul></div>");this.timeoutID=null;this.context.$el.append(this.$el);this.bindEvent()}a.prototype.init=function(){var b;b=this.context.getOpt("alias")||this.context.at.charCodeAt(0);return this.$el.attr({id:"at-view-"+b})};a.prototype.destroy=function(){return this.$el.remove()};a.prototype.bindEvent=function(){var b;b=this.$el.find("ul");return b.on("mouseenter.atwho-view","li",function(c){b.find(".cur").removeClass("cur");return v(c.currentTarget).addClass("cur")}).on("click.atwho-view","li",(function(c){return function(d){b.find(".cur").removeClass("cur");v(d.currentTarget).addClass("cur");c.choose(d);return d.preventDefault()}})(this))};a.prototype.visible=function(){return this.$el.is(":visible")};a.prototype.highlighted=function(){return this.$el.find(".cur").length>0};a.prototype.choose=function(c){var b,d;if((b=this.$el.find(".cur")).length){d=this.context.insertContentFor(b);this.context._stopDelayedCall();this.context.insert(this.context.callbacks("beforeInsert").call(this.context,d,b),b);this.context.trigger("inserted",[b,c]);this.hide(c)}if(this.context.getOpt("hideWithoutSuffix")){return this.stopShowing=true}};a.prototype.reposition=function(d){var b,c,f,e;b=this.context.app.iframeAsRoot?this.context.app.window:window;if(d.bottom+this.$el.height()-v(b).scrollTop()>v(b).height()){d.bottom=d.top-this.$el.height()}if(d.left>(f=v(b).width()-this.$el.width()-5)){d.left=f}c={left:d.left,top:d.bottom};if((e=this.context.callbacks("beforeReposition"))!=null){e.call(this.context,c)}this.$el.offset(c);return this.context.trigger("reposition",[c])};a.prototype.next=function(){var b,c;b=this.$el.find(".cur").removeClass("cur");c=b.next();if(!c.length){c=this.$el.find("li:first")}c.addClass("cur");return this.scrollTop(Math.max(0,b.innerHeight()*(c.index()+2)-this.$el.height()))};a.prototype.prev=function(){var b,c;b=this.$el.find(".cur").removeClass("cur");c=b.prev();if(!c.length){c=this.$el.find("li:last")}c.addClass("cur");return this.scrollTop(Math.max(0,b.innerHeight()*(c.index()+2)-this.$el.height()))};a.prototype.scrollTop=function(c){var b;b=this.context.getOpt("scrollDuration");if(b){return this.$el.animate({scrollTop:c},b)}else{return this.$el.scrollTop(c)}};a.prototype.show=function(){var b;if(this.stopShowing){this.stopShowing=false;return}if(!this.visible()){this.$el.show();this.$el.scrollTop(0);this.context.trigger("shown")}if(b=this.context.rect()){return this.reposition(b)}};a.prototype.hide=function(c,d){var b;if(!this.visible()){return}if(isNaN(d)){this.$el.hide();return this.context.trigger("hidden",[c])}else{b=(function(e){return function(){return e.hide()}})(this);clearTimeout(this.timeoutID);return this.timeoutID=setTimeout(b,d)}};a.prototype.render=function(c){var b,f,e,d,h,i,g;if(!(v.isArray(c)&&c.length>0)){this.hide();return}this.$el.find("ul").empty();f=this.$el.find("ul");g=this.context.getOpt("displayTpl");for(e=0,h=c.length;e<h;e++){d=c[e];d=v.extend({},d,{"atwho-at":this.context.at});i=this.context.callbacks("tplEval").call(this.context,g,d,"onDisplay");b=v(this.context.callbacks("highlighter").call(this.context,i,this.context.query.text));b.data("item-data",d);f.append(b)}this.show();if(this.context.getOpt("highlightFirst")){return f.find("li:first").addClass("cur")}};return a})();o={DOWN:40,UP:38,ESC:27,TAB:9,ENTER:13,CTRL:17,A:65,P:80,N:78,LEFT:37,UP:38,RIGHT:39,DOWN:40,BACKSPACE:8,SPACE:32};p={beforeSave:function(a){return w.arrayToDefaultHash(a)},matcher:function(h,e,b,a){var f,g,c,i,d;h=h.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");if(b){h="(?:^|\\s)"+h}f=decodeURI("%C3%80");g=decodeURI("%C3%BF");d=a?" ":"";i=new RegExp(h+"([A-Za-z"+f+"-"+g+"0-9_"+d+"'.+-]*)$|"+h+"([^\\x00-\\xff]*)$","gi");c=i.exec(e);if(c){return c[2]||c[1]}else{return null}},filter:function(b,c,a){var f,e,d,g;f=[];for(e=0,g=c.length;e<g;e++){d=c[e];if(~new String(d[a]).toLowerCase().indexOf(b.toLowerCase())){f.push(d)}}return f},remoteFilter:null,sorter:function(b,e,a){var f,d,c,g;if(!b){return e}f=[];for(d=0,g=e.length;d<g;d++){c=e[d];c.atwho_order=new String(c[a]).toLowerCase().indexOf(b.toLowerCase());if(c.atwho_order>-1){f.push(c)}}return f.sort(function(h,i){return h.atwho_order-i.atwho_order})},tplEval:function(d,b){var e,c;c=d;try{if(typeof d!=="string"){c=d(b)}return c.replace(/\$\{([^\}]*)\}/g,function(h,g,f){return b[g]})}catch(a){e=a;return""}},highlighter:function(c,a){var b;if(!a){return c}b=new RegExp(">\\s*(\\w*?)("+a.replace("+","\\+")+")(\\w*)\\s*<","ig");return c.replace(b,function(e,g,d,f){return"> "+g+"<strong>"+d+"</strong>"+f+" <"})},beforeInsert:function(b,a){return b},beforeReposition:function(a){return a},afterMatchFailed:function(b,a){}};t={load:function(c,b){var a;if(a=this.controller(c)){return a.model.load(b)}},isSelecting:function(){var a;return !!((a=this.controller())!=null?a.view.visible():void 0)},hide:function(){var a;return(a=this.controller())!=null?a.view.hide():void 0},reposition:function(){var a;if(a=this.controller()){return a.view.reposition(a.rect())}},setIframe:function(b,a){this.setupRootElement(b,a);return null},run:function(){return this.dispatch()},destroy:function(){this.shutdown();return this.$inputor.data("atwho",null)}};v.fn.atwho=function(a){var b,c;b=arguments;c=null;this.filter('textarea, input, [contenteditable=""], [contenteditable=true]').each(function(){var e,d;if(!(d=(e=v(this)).data("atwho"))){e.data("atwho",(d=new x(this)))}if(typeof a==="object"||!a){return d.reg(a.at,a)}else{if(t[a]&&d){return c=t[a].apply(d,Array.prototype.slice.call(b,1))}else{return v.error("Method "+a+" does not exist on jQuery.atwho")}}});if(c!=null){return c}else{return this}};v.fn.atwho["default"]={at:void 0,alias:void 0,data:null,displayTpl:"<li>${name}</li>",insertTpl:"${atwho-at}${name}",callbacks:p,searchKey:"name",suffix:void 0,hideWithoutSuffix:false,startWithSpace:true,highlightFirst:true,limit:5,maxLen:20,minLen:0,displayTimeout:300,delay:null,spaceSelectsMatch:false,tabSelectsMatch:true,editableAtwhoQueryAttrs:{},scrollDuration:150,suspendOnComposing:true,lookUpOnClick:true};v.fn.atwho.debug=false}));